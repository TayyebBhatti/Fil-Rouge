{% extends 'base.html.twig' %}
{% block title %}Mon Profil{% endblock %}

{% block body %}
    <div class="page-container">
        {% for msg in app.flashes('success') %}
            <div class="flash flash--success">{{ msg }}</div>
        {% endfor %}
        {% for msg in app.flashes('error') %}
            <div class="flash flash--error">{{ msg }}</div>
        {% endfor %}

        <h1 class="section-title">üë§ Mon Profil</h1>

        {% if 'ROLE_ADMIN' in user.roles %}
            <div class="profile-toolbar">
                <a class="btn btn-primary" href="{{ path('admin_utilisateur_index') }}">
                    üõ†Ô∏è G√©rer les utilisateurs
                </a>
            </div>
        {% endif %}

        <section class="card profile-section">
            <h2 class="card-title">üìã Informations personnelles</h2>
            <div class="card-divider"></div>

            {% set hasAbsoluteImage = user.image and (user.image starts with 'http://' or user.image starts with 'https://') %}
            {% set profileImage = hasAbsoluteImage ? user.image : (user.image ? asset(user.image) : asset('img/default-avatar.svg')) %}

            <div class="profile-header">
                <div class="avatar">
                    <img src="{{ profileImage }}" alt="Photo de profil de {{ user.prenom ?: user.nom ?: user.email }}">
                </div>
                <div class="profile-header__details">
                    <div>
                        <p class="data-item-title">Adresse email</p>
                        <p class="data-item-value">{{ user.email }}</p>
                    </div>
                </div>
            </div>

            <div class="profile-grid">
                <div>
                    <p class="data-item-title">Nom</p>
                    <p class="data-item-value">{{ user.nom ?: '‚Äî' }}</p>
                </div>
                <div>
                    <p class="data-item-title">Pr√©nom</p>
                    <p class="data-item-value">{{ user.prenom ?: '‚Äî' }}</p>
                </div>
                <div>
                    <p class="data-item-title">R√¥le</p>
                    <p class="data-item-value">
                        {% if 'ROLE_ADMIN' in user.roles %}
                            <span class="badge badge-success">Administrateur</span>
                        {% else %}
                            <span class="badge badge-info">Utilisateur</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </section>

        <section class="card profile-section">
            <h2 class="card-title">üéüÔ∏è Mes inscriptions ({{ mesInscriptions|length }})</h2>
            <div class="card-divider"></div>

            {% if mesInscriptions is empty %}
                <div class="profile-empty">
                    Vous n'√™tes inscrit √† aucun √©v√©nement pour le moment.
                </div>
                <div class="form-actions form-actions--center">
                    <a class="btn btn-primary" href="{{ path('default_home') }}">D√©couvrir les √©v√©nements</a>
                </div>
            {% else %}
                <div class="card-grid card-grid--responsive">
                    {% for inscription in mesInscriptions %}
                        {% set e = inscription.evenement %}
                        <article class="event-card event-card--compact event-card--muted">
                            {% if e.image %}
                                <img src="{{ asset(e.image) }}" alt="Image de {{ e.titre }}">
                            {% else %}
                                <img src="{{ asset('img/default.jpg') }}" alt="Image par d√©faut">
                            {% endif %}

                            <div class="event-card__body">
                                <h3 class="event-card__title">{{ e.titre }}</h3>
                                <div class="event-meta">
                                    <span>üìÖ {{ e.dateDebut ? e.dateDebut|date('d/m/Y H:i') : 'Date √† venir' }}</span>
                                    {% if e.lieu %}
                                        <span>üìç {{ e.lieu.ville ?: '' }}{% if e.lieu.pays %}, {{ e.lieu.pays }}{% endif %}</span>
                                    {% endif %}
                                    <span class="data-item-title">Inscrit le {{ inscription.dateInscription ? inscription.dateInscription|date('d/m/Y') : '‚Äî' }}</span>
                                </div>

                                <div class="event-card__actions">
                                    <a class="btn btn-outline btn-full" href="{{ path('evenement_show', {id: e.id}) }}">Voir d√©tails</a>
                                    <form class="btn-full" method="post" action="{{ path('evenement_unregister', {id: e.id}) }}">
                                        <input type="hidden" name="_token" value="{{ csrf_token('desinscrire_' ~ e.id) }}">
                                        <button class="btn btn-danger btn-full" type="submit">Se d√©sinscrire</button>
                                    </form>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% endif %}
        </section>

        {% if mesEvenementsCrees is not empty %}
            <section class="card profile-section">
                <h2 class="card-title">‚ú® √âv√©nements que j'ai cr√©√©s ({{ mesEvenementsCrees|length }})</h2>
                <div class="card-divider"></div>

                <div class="card-grid card-grid--responsive">
                    {% for e in mesEvenementsCrees %}
                        <article class="event-card event-card--compact">
                            {% if e.image %}
                                <img src="{{ asset(e.image) }}" alt="Image de {{ e.titre }}">
                            {% else %}
                                <img src="{{ asset('img/default.jpg') }}" alt="Image par d√©faut">
                            {% endif %}

                            <div class="event-card__body">
                                <h3 class="event-card__title">{{ e.titre }}</h3>
                                <div class="event-meta">
                                    <span>üìÖ {{ e.dateDebut ? e.dateDebut|date('d/m/Y H:i') : 'Date √† venir' }}</span>
                                    <span>üë• {{ e.inscriptions|length }} inscrit(s){% if e.capaciteMax %} / {{ e.capaciteMax }}{% endif %}</span>
                                </div>

                                <div class="event-card__actions">
                                    <a class="btn btn-outline btn-full" href="{{ path('evenement_show', {id: e.id}) }}">Voir d√©tails</a>
                                    {% if 'ROLE_ADMIN' in user.roles %}
                                        <a class="btn btn-success btn-full" href="{{ path('admin_evenement_edit', {id: e.id}) }}">Modifier</a>
                                    {% endif %}
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            </section>
        {% endif %}

        <a class="profile-return" href="{{ path('default_home') }}">‚Üê Retour √† l'accueil</a>
    </div>
{% endblock %}
