{% extends "base.html.twig" %}
{% block title %}Accueil{% endblock %}

{% block body %}
  {% for msg in app.flashes('success') %}
    <div style="padding:8px;border:1px solid #16a34a;color:#14532d;border-radius:8px;margin-bottom:10px;">{{ msg }}</div>
  {% endfor %}
  {% for msg in app.flashes('error') %}
    <div style="padding:8px;border:1px solid #dc2626;color:#7f1d1d;border-radius:8px;margin-bottom:10px;">{{ msg }}</div>
  {% endfor %}

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h1>√âv√©nements</h1>
    {% if app.user and 'ROLE_ADMIN' in app.user.roles %}
      <a href="{{ path('admin_evenement_index') }}"
         style="padding:10px 16px;border:1px solid #16a34a;border-radius:8px;background:#16a34a;color:white;text-decoration:none;font-weight:500;">
        + Modifier/Ajouter √©v√©nements
      </a>
    {% endif %}
  </div>

  {% if evenements is empty %}
    <p>Aucun √©v√©nement.</p>
  {% else %}
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;">
      {% for e in evenements %}
        {% set nbInsc = e.inscriptions is defined ? e.inscriptions|length : 0 %}
        {% set isRegistered = app.user and (e.id in registeredEventIds) %}

        <article style="border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.1);background:white;">
          {% if e.image %}
            <img src="{{ asset(e.image) }}" alt="Image de {{ e.titre }}" style="width:100%;height:180px;object-fit:cover;">
          {% else %}
            <img src="{{ asset('img/default.jpg') }}" alt="Image par d√©faut" style="width:100%;height:180px;object-fit:cover;">
          {% endif %}

          <div style="padding:12px;">
            <h2 style="margin:4px 0 6px;font-size:1.2rem;">{{ e.titre ?? ('√âv√©nement #' ~ e.id) }}</h2>

            <p style="margin:0;color:#555;">
              {{ e.dateDebut ? e.dateDebut|date('d/m/Y H:i') : 'Date √† venir' }}
              {% if e.dateFin %} ‚Üí {{ e.dateFin|date('d/m/Y H:i') }}{% endif %}
            </p>

            {% if e.lieu %}
              <p style="margin:4px 0;color:#444;">
                üìç
                {% if e.lieu.rue is defined and e.lieu.rue %}{{ e.lieu.rue }}, {% endif %}
                {% if e.lieu.code_postal is defined and e.lieu.code_postal %}{{ e.lieu.code_postal }} {% endif %}
                {% if e.lieu.ville is defined and e.lieu.ville %}{{ e.lieu.ville }}{% endif %}
                {% if e.lieu.pays is defined and e.lieu.pays %} ‚Ä¢ {{ e.lieu.pays }}{% endif %}
              </p>
            {% endif %}

            {% if e.categorie %}
              <p style="margin:4px 0;color:#666;">üè∑Ô∏è {{ e.categorie.nom ?? e.categorie }}</p>
            {% endif %}

            {% if e.description %}
              <p style="margin-top:6px;color:#333;">{{ e.description|u.truncate(120, '‚Ä¶', false) }}</p>
            {% endif %}

            <p style="margin:6px 0;color:#333;">
              {% if e.capaciteMax is defined %}
                {{ nbInsc }}/{{ e.capaciteMax }} inscrits
              {% else %}
                {{ nbInsc }} inscrit(s)
              {% endif %}
            </p>

            <div style="display:flex;gap:8px;margin-top:10px;">
              <a href="{{ path('evenement_show', {id: e.id}) }}"
                 style="flex:1;text-align:center;padding:8px 12px;border:1px solid #0ea5e9;border-radius:8px;text-decoration:none;color:#075985;">
                D√©tails
              </a>

              {% if app.user %}
                {% if isRegistered %}
                  <form method="post" action="{{ path('evenement_unregister', {id: e.id}) }}" style="flex:1;">
                    <input type="hidden" name="_token" value="{{ csrf_token('desinscrire_' ~ e.id) }}">
                    <button type="submit"
                            style="width:100%;padding:8px 12px;border:1px solid #dc2626;border-radius:8px;background:#dc2626;color:white;cursor:pointer;">
                      Se d√©sinscrire
                    </button>
                  </form>
                {% else %}
                  <form method="post" action="{{ path('evenement_register', {id: e.id}) }}" style="flex:1;">
                    <input type="hidden" name="_token" value="{{ csrf_token('inscrire_' ~ e.id) }}">
                    <button type="submit"
                            style="width:100%;padding:8px 12px;border:1px solid #16a34a;border-radius:8px;background:#16a34a;color:white;cursor:pointer;">
                      S‚Äôinscrire
                    </button>
                  </form>
                {% endif %}
              {% else %}
                <a href="{{ path('default_login') }}"
                   style="flex:1;text-align:center;padding:8px 12px;border:1px solid #0ea5e9;border-radius:8px;text-decoration:none;color:#075985;">
                  Se connecter
                </a>
              {% endif %}
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}


{% block stylesheets %}

{% endblock %}
