{% extends "base.html.twig" %}
{% block title %}Accueil{% endblock %}

{% block body %}
    <div class="page-container">
        {% for msg in app.flashes('success') %}
            <div class="flash flash--success">{{ msg }}</div>
        {% endfor %}
        {% for msg in app.flashes('error') %}
            <div class="flash flash--error">{{ msg }}</div>
        {% endfor %}

        <section class="hero-banner">
            <div class="hero-banner__header">
                <h1 class="hero-banner__title">√âv√©nements</h1>
                {% if app.user and 'ROLE_ADMIN' in app.user.roles %}
                    <a class="btn btn-success" href="{{ path('admin_evenement_index') }}">
                        + Modifier/Ajouter des √©v√©nements
                    </a>
                {% endif %}
            </div>
            <p class="hero-banner__description">
                Explorez les √©v√©nements √† venir, filtrez par cat√©gorie ou p√©riode et rejoignez ceux qui vous inspirent.
            </p>
        </section>

        <div class="card">
            <form class="form-grid" method="get" action="{{ path('default_home') }}">
                <div class="form-field">
                    <label for="search">üîç Recherche</label>
                    <input type="text"
                           id="search"
                           name="search"
                           value="{{ currentSearch }}"
                           placeholder="Rechercher par titre, description, ville ou pays...">
                </div>

                <div class="form-grid form-grid--two-columns">
                    <div class="form-field">
                        <label for="categorie">üè∑Ô∏è Cat√©gorie</label>
                        <select id="categorie" name="categorie">
                            <option value="">Toutes les cat√©gories</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if currentCategorie == cat.id %}selected{% endif %}>
                                    {{ cat.nom }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-field">
                        <label for="date_debut">üìÖ √Ä partir du</label>
                        <input type="date"
                               id="date_debut"
                               name="date_debut"
                               value="{{ currentDateDebut }}">
                    </div>

                    <div class="form-field">
                        <label for="date_fin">üìÖ Jusqu'au</label>
                        <input type="date"
                               id="date_fin"
                               name="date_fin"
                               value="{{ currentDateFin }}">
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-primary" type="submit">üîé Rechercher</button>
                    <a class="btn btn-ghost" href="{{ path('default_home') }}">‚úñÔ∏è R√©initialiser</a>
                </div>
            </form>
        </div>

        {% if currentSearch or currentCategorie or currentDateDebut or currentDateFin %}
            <p class="section-subtitle">
                {{ evenements|length }} r√©sultat(s) trouv√©(s)
            </p>
        {% endif %}

        {% if evenements is empty %}
            <div class="empty-state">
                <p>Aucun √©v√©nement ne correspond √† vos crit√®res pour le moment.</p>
                {% if currentSearch or currentCategorie or currentDateDebut or currentDateFin %}
                    <a class="btn btn-outline" href="{{ path('default_home') }}">Voir tous les √©v√©nements</a>
                {% endif %}
            </div>
        {% else %}
            <div class="event-grid">
                {% for e in evenements %}
                    {% set nbInsc = e.inscriptions is defined ? e.inscriptions|length : 0 %}
                    {% set isRegistered = app.user and (e.id in registeredEventIds) %}

                    <article class="event-card">
                        {% if e.image %}
                            <img src="{{ asset(e.image) }}" alt="Image de {{ e.titre }}">
                        {% else %}
                            <img src="{{ asset('img/default.jpg') }}" alt="Image par d√©faut">
                        {% endif %}

                        <div class="event-card__body">
                            <h2 class="event-card__title">{{ e.titre ?? ('√âv√©nement #' ~ e.id) }}</h2>
                            <div class="event-meta">
                                <span>
                                    üìÖ {{ e.dateDebut ? e.dateDebut|date('d/m/Y H:i') : 'Date √† venir' }}
                                    {% if e.dateFin %} ‚Üí {{ e.dateFin|date('d/m/Y H:i') }}{% endif %}
                                </span>

                                {% if e.lieu %}
                                    <span>
                                        üìç
                                        {% if e.lieu.rue is defined and e.lieu.rue %}{{ e.lieu.rue }}, {% endif %}
                                        {% if e.lieu.code_postal is defined and e.lieu.code_postal %}{{ e.lieu.code_postal }} {% endif %}
                                        {% if e.lieu.ville is defined and e.lieu.ville %}{{ e.lieu.ville }}{% endif %}
                                        {% if e.lieu.pays is defined and e.lieu.pays %} ‚Ä¢ {{ e.lieu.pays }}{% endif %}
                                    </span>
                                {% endif %}

                                {% if e.categorie %}
                                    <span>üè∑Ô∏è {{ e.categorie.nom ?? e.categorie }}</span>
                                {% endif %}

                                {% if e.description %}
                                    <span>{{ e.description|u.truncate(120, '‚Ä¶', false) }}</span>
                                {% endif %}

                                <span>
                                    {% if e.capaciteMax is defined %}
                                        üë• {{ nbInsc }}/{{ e.capaciteMax }} inscrit(s)
                                    {% else %}
                                        üë• {{ nbInsc }} inscrit(s)
                                    {% endif %}
                                </span>
                            </div>

                            <div class="event-card__actions">
                                <a class="btn btn-outline btn-full" href="{{ path('evenement_show', {id: e.id}) }}">D√©tails</a>

                                {% if app.user %}
                                    {% if isRegistered %}
                                        <form class="btn-full" method="post" action="{{ path('evenement_unregister', {id: e.id}) }}">
                                            <input type="hidden" name="_token" value="{{ csrf_token('desinscrire_' ~ e.id) }}">
                                            <button class="btn btn-danger btn-full" type="submit">Se d√©sinscrire</button>
                                        </form>
                                    {% else %}
                                        <form class="btn-full" method="post" action="{{ path('evenement_register', {id: e.id}) }}">
                                            <input type="hidden" name="_token" value="{{ csrf_token('inscrire_' ~ e.id) }}">
                                            <button class="btn btn-success btn-full" type="submit">S'inscrire</button>
                                        </form>
                                    {% endif %}
                                {% else %}
                                    <a class="btn btn-primary btn-full" href="{{ path('default_login') }}">Se connecter</a>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% endif %}
    </div>
{% endblock %}
