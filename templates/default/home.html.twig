{% extends "base.html.twig" %}
{% block title %}Accueil{% endblock %}

{% block body %}
  {% for msg in app.flashes('success') %}
    <div style="padding:8px;border:1px solid #16a34a;color:#14532d;border-radius:8px;margin-bottom:10px;">{{ msg }}</div>
  {% endfor %}
  {% for msg in app.flashes('error') %}
    <div style="padding:8px;border:1px solid #dc2626;color:#7f1d1d;border-radius:8px;margin-bottom:10px;">{{ msg }}</div>
  {% endfor %}

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h1>√âv√©nements</h1>
    {% if app.user and 'ROLE_ADMIN' in app.user.roles %}
      <a href="{{ path('admin_evenement_index') }}"
         style="padding:10px 16px;border:1px solid #16a34a;border-radius:8px;background:#16a34a;color:white;text-decoration:none;font-weight:500;">
        + Modifier/Ajouter √©v√©nements
      </a>
    {% endif %}
  </div>

  <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:20px;margin-bottom:30px;">
    <form method="get" action="{{ path('default_home') }}">
      <div style="display:grid;grid-template-columns:1fr;gap:15px;">
        
        <div>
          <label for="search" style="display:block;margin-bottom:5px;font-weight:500;color:#374151;">üîç Recherche</label>
          <input type="text" 
                 id="search" 
                 name="search" 
                 value="{{ currentSearch }}"
                 placeholder="Rechercher par titre, description, ville ou pays..."
                 style="width:94%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:1rem;">
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;">
          
          <div>
            <label for="categorie" style="display:block;margin-bottom:5px;font-weight:500;color:#374151;">üè∑Ô∏è Cat√©gorie</label>
            <select id="categorie" 
                    name="categorie"
                    style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:1rem;">
              <option value="">Toutes les cat√©gories</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}" {% if currentCategorie == cat.id %}selected{% endif %}>
                  {{ cat.nom }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="date_debut" style="display:block;margin-bottom:5px;font-weight:500;color:#374151;">üìÖ √Ä partir du</label>
            <input type="date" 
                   id="date_debut" 
                   name="date_debut" 
                   value="{{ currentDateDebut }}"
                   style="width:80%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:1rem;">
          </div>

          <div>
            <label for="date_fin" style="display:block;margin-bottom:5px;font-weight:500;color:#374151;">üìÖ Jusqu'au</label>
            <input type="date" 
                   id="date_fin" 
                   name="date_fin" 
                   value="{{ currentDateFin }}"
                   style="width:80%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:1rem;">
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button type="submit" 
                  style="padding:10px 20px;border:1px solid #0ea5e9;border-radius:8px;background:#0ea5e9;color:white;cursor:pointer;font-weight:500;">
            üîé Rechercher
          </button>
          <a href="{{ path('default_home') }}"
             style="padding:10px 20px;border:1px solid #9ca3af;border-radius:8px;background:#f3f4f6;color:#374151;text-decoration:none;font-weight:500;">
            ‚úñÔ∏è R√©initialiser
          </a>
        </div>
      </div>
    </form>
  </div>
  {% if currentSearch or currentCategorie or currentDateDebut or currentDateFin %}
    <p style="margin-bottom:15px;color:#6b7280;font-style:italic;">
      {{ evenements|length }} r√©sultat(s) trouv√©(s)
    </p>
  {% endif %}

  {% if evenements is empty %}
    <div style="text-align:center;padding:40px;background:#f9fafb;border-radius:12px;">
      <p style="font-size:1.2rem;color:#6b7280;">Aucun √©v√©nement trouv√©.</p>
      {% if currentSearch or currentCategorie or currentDateDebut or currentDateFin %}
        <a href="{{ path('default_home') }}"
           style="display:inline-block;margin-top:10px;padding:8px 16px;border:1px solid #0ea5e9;border-radius:8px;color:#075985;text-decoration:none;">
          Voir tous les √©v√©nements
        </a>
      {% endif %}
    </div>
  {% else %}
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;">
      {% for e in evenements %}
        {% set nbInsc = e.inscriptions is defined ? e.inscriptions|length : 0 %}
        {% set isRegistered = app.user and (e.id in registeredEventIds) %}

        <article style="border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.1);background:white;">
          {% if e.image %}
            <img src="{{ asset(e.image) }}" alt="Image de {{ e.titre }}" style="width:100%;height:180px;object-fit:cover;">
          {% else %}
            <img src="{{ asset('img/default.jpg') }}" alt="Image par d√©faut" style="width:100%;height:180px;object-fit:cover;">
          {% endif %}

          <div style="padding:12px;">
            <h2 style="margin:4px 0 6px;font-size:1.2rem;">{{ e.titre ?? ('√âv√©nement #' ~ e.id) }}</h2>

            <p style="margin:0;color:#555;">
              {{ e.dateDebut ? e.dateDebut|date('d/m/Y H:i') : 'Date √† venir' }}
              {% if e.dateFin %} ‚Üí {{ e.dateFin|date('d/m/Y H:i') }}{% endif %}
            </p>

            {% if e.lieu %}
              <p style="margin:4px 0;color:#444;">
                üìç
                {% if e.lieu.rue is defined and e.lieu.rue %}{{ e.lieu.rue }}, {% endif %}
                {% if e.lieu.code_postal is defined and e.lieu.code_postal %}{{ e.lieu.code_postal }} {% endif %}
                {% if e.lieu.ville is defined and e.lieu.ville %}{{ e.lieu.ville }}{% endif %}
                {% if e.lieu.pays is defined and e.lieu.pays %} ‚Ä¢ {{ e.lieu.pays }}{% endif %}
              </p>
            {% endif %}

            {% if e.categorie %}
              <p style="margin:4px 0;color:#666;">üè∑Ô∏è {{ e.categorie.nom ?? e.categorie }}</p>
            {% endif %}

            {% if e.description %}
              <p style="margin-top:6px;color:#333;">{{ e.description|u.truncate(120, '‚Ä¶', false) }}</p>
            {% endif %}

            <p style="margin:6px 0;color:#333;">
              {% if e.capaciteMax is defined %}
                {{ nbInsc }}/{{ e.capaciteMax }} inscrits
              {% else %}
                {{ nbInsc }} inscrit(s)
              {% endif %}
            </p>

            <div style="display:flex;gap:8px;margin-top:10px;">
              <a href="{{ path('evenement_show', {id: e.id}) }}"
                 style="flex:1;text-align:center;padding:8px 12px;border:1px solid #0ea5e9;border-radius:8px;text-decoration:none;color:#075985;">
                D√©tails
              </a>

              {% if app.user %}
                {% if isRegistered %}
                  <form method="post" action="{{ path('evenement_unregister', {id: e.id}) }}" style="flex:1;">
                    <input type="hidden" name="_token" value="{{ csrf_token('desinscrire_' ~ e.id) }}">
                    <button type="submit"
                            style="width:100%;padding:8px 12px;border:1px solid #dc2626;border-radius:8px;background:#dc2626;color:white;cursor:pointer;">
                      Se d√©sinscrire
                    </button>
                  </form>
                {% else %}
                  <form method="post" action="{{ path('evenement_register', {id: e.id}) }}" style="flex:1;">
                    <input type="hidden" name="_token" value="{{ csrf_token('inscrire_' ~ e.id) }}">
                    <button type="submit"
                            style="width:100%;padding:8px 12px;border:1px solid #16a34a;border-radius:8px;background:#16a34a;color:white;cursor:pointer;">
                      S'inscrire
                    </button>
                  </form>
                {% endif %}
              {% else %}
                <a href="{{ path('default_login') }}"
                   style="flex:1;text-align:center;padding:8px 12px;border:1px solid #0ea5e9;border-radius:8px;text-decoration:none;color:#075985;">
                  Se connecter
                </a>
              {% endif %}
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}


{% block stylesheets %}

{% endblock %}